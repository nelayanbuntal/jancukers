import discord
from discord.ext import commands
from discord import ui, Interaction
import asyncio
import random
import os
from datetime import datetime
import traceback

# Import modules
from redeem_core import run_redeem_process
import config
from database import (
    init_database, get_balance, deduct_balance, 
    create_redeem, get_user_stats, get_topup_by_order_id,
    create_topup, get_redeem_queue_count, get_database_stats
)
from payment_gateway import MidtransPayment, generate_order_id, format_rupiah
import webhook_server

# ==============================
# BOT CONFIG
# ==============================
intents = discord.Intents.default()
intents.message_content = True
intents.members = True

# ==============================
# Global State Management
# ==============================
user_data = {}          # user_id -> parameter data
active_channels = {}    # user_id -> channel_id
live_logs = {}          # channel_id -> list of log lines
live_panel_message = {} # channel_id -> discord.Message
last_update = {}        # channel_id -> timestamp

# ==============================
# Queue & Worker Management
# ==============================
login_queue = asyncio.Queue()
worker_status = {}      # worker_id -> status

# ==============================
# Payment Gateway
# ==============================
try:
    midtrans = MidtransPayment(
        server_key=config.MIDTRANS_SERVER_KEY,
        is_production=config.MIDTRANS_IS_PRODUCTION
    )
except Exception as e:
    print(f"‚ö†Ô∏è Midtrans initialization warning: {e}")
    midtrans = None

# ==============================
# Retry Decorator untuk Bot Operations
# ==============================
def retry_async(max_attempts=3, delay=2, backoff=2):
    """Decorator untuk retry async operations"""
    def decorator(func):
        async def wrapper(*args, **kwargs):
            for attempt in range(max_attempts):
                try:
                    return await func(*args, **kwargs)
                except discord.HTTPException as e:
                    if attempt < max_attempts - 1:
                        wait_time = delay * (backoff ** attempt)
                        print(f"‚ö†Ô∏è Discord API error, retrying in {wait_time}s: {e}")
                        await asyncio.sleep(wait_time)
                        continue
                    raise
                except Exception as e:
                    if attempt < max_attempts - 1:
                        print(f"‚ö†Ô∏è Error in {func.__name__}, retrying: {e}")
                        await asyncio.sleep(delay * (backoff ** attempt))
                        continue
                    raise
        return wrapper
    return decorator

# ==============================
# Login Worker dengan Error Recovery
# ==============================
async def login_worker(worker_id: int):
    """Worker untuk proses redeem dengan comprehensive error handling"""
    worker_status[worker_id] = "idle"
    
    while True:
        try:
            task = await login_queue.get()
            worker_status[worker_id] = "processing"
            
            user_id = task["user_id"]
            email = task["email"]
            password = task["password"]
            channel = task["channel"]
            android_choice = task["android_choice"]
            region = task["region"]
            code_file = task["code_file"]

            loop = asyncio.get_event_loop()

            def login_task():
                return run_redeem_process(
                    code_file=code_file,
                    email=email,
                    password=password,
                    region_input=region,
                    android_choice=android_choice,
                    progress_callback=make_progress_callback(channel),
                    user_id=user_id
                )

            try:
                # Jalankan redeem dengan timeout protection
                result = await asyncio.wait_for(
                    loop.run_in_executor(None, login_task),
                    timeout=1800  # 30 menit timeout
                )
                
                # Kirim completion message
                await safe_send_completion(channel, user_id, result)
                
            except asyncio.TimeoutError:
                await safe_send(channel, 
                    "‚è±Ô∏è **Proses redeem timeout**\n\n"
                    "Proses melebihi batas waktu yang ditentukan. "
                    "Silakan coba lagi dengan kode yang lebih sedikit atau hubungi admin."
                )
                
            except Exception as e:
                error_msg = str(e)
                print(f"‚ùå Worker {worker_id} error: {error_msg}")
                print(traceback.format_exc())
                
                await safe_send(channel,
                    "‚ùå **Terjadi Kesalahan**\n\n"
                    "Maaf, terjadi kesalahan saat memproses redeem Anda. "
                    "Tim kami telah menerima laporan error ini.\n\n"
                    "üí° Silakan coba lagi dalam beberapa saat atau hubungi admin untuk bantuan."
                )
            
            finally:
                # Cleanup
                try:
                    if os.path.exists(code_file):
                        os.remove(code_file)
                except:
                    pass
                
                login_queue.task_done()
                worker_status[worker_id] = "idle"
                
        except Exception as e:
            print(f"‚ùå Critical error in worker {worker_id}: {e}")
            print(traceback.format_exc())
            worker_status[worker_id] = "error"
            await asyncio.sleep(5)  # Cooldown sebelum retry
            worker_status[worker_id] = "idle"

# ==============================
# Safe Message Sending
# ==============================
@retry_async(max_attempts=3)
async def safe_send(channel, content=None, embed=None, view=None):
    """Send message with retry logic"""
    try:
        return await channel.send(content=content, embed=embed, view=view)
    except discord.Forbidden:
        print(f"‚ö†Ô∏è Cannot send message to channel {channel.id} (no permission)")
        return None
    except discord.HTTPException as e:
        print(f"‚ö†Ô∏è HTTP error sending message: {e}")
        raise

async def safe_send_completion(channel, user_id, result):
    """Send completion message with statistics"""
    try:
        # Hitung statistik
        success_file = f"success_{user_id}.txt"
        invalid_file = f"invalid_{user_id}.txt"
        
        success_count = 0
        invalid_count = 0
        
        if os.path.exists(success_file):
            with open(success_file, 'r', encoding='utf-8') as f:
                success_count = len([l for l in f.readlines() if l.strip()])
        
        if os.path.exists(invalid_file):
            with open(invalid_file, 'r', encoding='utf-8') as f:
                invalid_count = len([l for l in f.readlines() if l.strip()])
        
        # Header message
        await safe_send(channel, "‚úÖ **Proses Redeem Selesai**")
        
        # Summary embed
        if success_count > 0:
            color = 0x2ecc71  # Green
            status_emoji = "üéâ"
            status_text = "Berhasil"
        elif invalid_count > 0:
            color = 0xe67e22  # Orange
            status_emoji = "‚ö†Ô∏è"
            status_text = "Selesai dengan Peringatan"
        else:
            color = 0xe74c3c  # Red
            status_emoji = "‚ùå"
            status_text = "Tidak Ada Kode Valid"
        
        embed = discord.Embed(
            title=f"{status_emoji} Hasil Redeem Code",
            description="Berikut adalah ringkasan proses redeem Anda:",
            color=color
        )
        
        embed.add_field(
            name="‚úÖ Kode Berhasil", 
            value=f"**{success_count}** kode", 
            inline=True
        )
        embed.add_field(
            name="‚ùå Kode Invalid/Gagal", 
            value=f"**{invalid_count}** kode", 
            inline=True
        )
        embed.add_field(
            name="üìÅ File Log",
            value=f"`{success_file}`\n`{invalid_file}`",
            inline=False
        )
        
        if success_count > 0:
            embed.add_field(
                name="üí° Informasi",
                value="Kode yang berhasil telah tersimpan dan siap digunakan.",
                inline=False
            )
        else:
            embed.add_field(
                name="üí° Saran",
                value="Pastikan kode yang Anda masukkan valid dan belum pernah digunakan.",
                inline=False
            )
        
        embed.set_footer(text=f"Status: {status_text} ‚Ä¢ {datetime.now().strftime('%d/%m/%Y %H:%M')}")
        
        await safe_send(channel, embed=embed)
        
    except Exception as e:
        print(f"‚ö†Ô∏è Error sending completion: {e}")
        # Fallback simple message
        await safe_send(channel, "‚úÖ Proses redeem selesai. Silakan cek file log untuk detail.")

# ==============================
# Live Log Update
# ==============================
async def update_live_panel(channel):
    """Update live log panel dengan throttling"""
    try:
        if channel.id not in live_panel_message:
            msg = await safe_send(channel, embed=discord.Embed(
                title="üìä Status Redeem",
                description="Memulai proses...",
                color=0x3498db
            ))
            if msg:
                live_panel_message[channel.id] = msg

        # Throttling
        last = last_update.get(channel.id, 0)
        now = asyncio.get_event_loop().time()
        if now - last < 3:  # Update setiap 3 detik
            return

        log_lines = live_logs.get(channel.id, [])
        recent_logs = log_lines[-8:] if log_lines else ["Menunggu proses..."]
        
        embed = discord.Embed(
            title="üìä Status Redeem",
            description="\n".join(recent_logs),
            color=0x3498db
        )
        embed.set_footer(text="Log diperbarui setiap beberapa detik")
        
        if channel.id in live_panel_message:
            await live_panel_message[channel.id].edit(embed=embed)
        
        last_update[channel.id] = now
        
    except discord.NotFound:
        # Message deleted, remove from tracking
        if channel.id in live_panel_message:
            del live_panel_message[channel.id]
    except Exception as e:
        print(f"‚ö†Ô∏è Error updating live panel: {e}")

def make_progress_callback(channel):
    """Callback untuk update progress"""
    def progress_callback(key, text):
        if channel.id not in live_logs:
            live_logs[channel.id] = []
        live_logs[channel.id].append(text)
        asyncio.run_coroutine_threadsafe(update_live_panel(channel), bot.loop)
    return progress_callback

# ==============================
# Bot Setup - FIXED: Disable built-in help command
# ==============================
class MyBot(commands.Bot):
    async def setup_hook(self):
        """Initialize bot components"""
        try:
            # Database
            init_database()
            print("‚úÖ Database initialized")
            
            # Start workers
            for i in range(config.MAX_LOGIN_WORKERS):
                asyncio.create_task(login_worker(i))
            print(f"‚úÖ Started {config.MAX_LOGIN_WORKERS} workers")
            
            # Add persistent views
            self.add_view(MainMenuView())
            self.add_view(StartFormButton())
            self.add_view(UserHelpView())
            self.add_view(AdminControlPanel())
            print("‚úÖ Persistent views added")
            
        except Exception as e:
            print(f"‚ùå Setup error: {e}")
            print(traceback.format_exc())

# Disable built-in help command
bot = MyBot(command_prefix="!", intents=intents, help_command=None)

# ==============================
# Main Menu View
# ==============================
class MainMenuView(ui.View):
    def __init__(self):
        super().__init__(timeout=None)

    @ui.button(
        label="üéÆ Mulai Redeem",
        style=discord.ButtonStyle.green,
        custom_id="start_redeem_button"
    )
    async def start_redeem(self, interaction: Interaction, button: ui.Button):
        """Buat channel privat untuk redeem"""
        user = interaction.user

        # Cek saldo
        user_balance = get_balance(user.id)
        min_balance = config.REDEEM_COST_PER_CODE
        
        if user_balance < min_balance:
            shortage = min_balance - user_balance
            embed = discord.Embed(
                title="üí≥ Saldo Tidak Mencukupi",
                description="Maaf, saldo Anda belum cukup untuk memulai redeem.",
                color=0xe74c3c
            )
            embed.add_field(
                name="Saldo Anda", 
                value=format_rupiah(user_balance), 
                inline=True
            )
            embed.add_field(
                name="Minimal Saldo", 
                value=format_rupiah(min_balance), 
                inline=True
            )
            embed.add_field(
                name="üí° Cara Top Up",
                value="Klik tombol **üí∞ Top Up Saldo** di menu utama untuk mengisi saldo.",
                inline=False
            )
            return await interaction.response.send_message(embed=embed, ephemeral=True)

        # Cek channel aktif
        if user.id in active_channels:
            ch_id = active_channels[user.id]
            existing_channel = interaction.guild.get_channel(ch_id)
            if existing_channel:
                return await interaction.response.send_message(
                    f"‚ÑπÔ∏è Anda sudah memiliki sesi aktif di {existing_channel.mention}",
                    ephemeral=True
                )
            else:
                active_channels.pop(user.id)

        try:
            guild = interaction.guild
            category = discord.utils.get(guild.categories, name="üéÆ Redeem Sessions")
            if category is None:
                category = await guild.create_category("üéÆ Redeem Sessions")

            rand = random.randint(1000, 9999)
            channel_name = f"redeem-{user.name[:10]}-{rand}"

            overwrites = {
                guild.default_role: discord.PermissionOverwrite(read_messages=False),
                user: discord.PermissionOverwrite(read_messages=True, send_messages=True),
                guild.me: discord.PermissionOverwrite(read_messages=True, send_messages=True),
            }

            admin_role = discord.utils.get(guild.roles, name=config.ADMIN_ROLE_NAME)
            if admin_role:
                overwrites[admin_role] = discord.PermissionOverwrite(read_messages=True, send_messages=True)

            redeem_channel = await guild.create_text_channel(
                channel_name, overwrites=overwrites, category=category
            )

            active_channels[user.id] = redeem_channel.id

            await interaction.response.send_message(
                f"‚úÖ Channel privat berhasil dibuat: {redeem_channel.mention}",
                ephemeral=True
            )

            welcome_embed = discord.Embed(
                title="üëã Selamat Datang di Sesi Redeem",
                description=f"Halo {user.mention}! Mari kita mulai proses redeem code Anda.",
                color=0x3498db
            )
            welcome_embed.add_field(
                name="üìã Langkah Selanjutnya",
                value="Klik tombol **Input Parameter** di bawah untuk mengisi informasi akun Anda.",
                inline=False
            )
            welcome_embed.add_field(
                name="üí° Tips",
                value="‚Ä¢ Pastikan informasi akun sudah benar\n"
                      "‚Ä¢ Siapkan file `code.txt` berisi kode redeem\n"
                      "‚Ä¢ Satu baris untuk satu kode",
                inline=False
            )
            welcome_embed.set_footer(text="Channel ini akan otomatis terhapus setelah selesai")

            await redeem_channel.send(embed=welcome_embed, view=StartFormButton())
            
        except Exception as e:
            print(f"‚ùå Error creating channel: {e}")
            await interaction.response.send_message(
                "‚ùå Maaf, terjadi kesalahan saat membuat channel. Silakan coba lagi atau hubungi admin.",
                ephemeral=True
            )

    @ui.button(
        label="üí∞ Top Up Saldo",
        style=discord.ButtonStyle.blurple,
        custom_id="topup_button"
    )
    async def topup(self, interaction: Interaction, button: ui.Button):
        """Buka modal topup"""
        if not midtrans:
            return await interaction.response.send_message(
                "‚ö†Ô∏è Sistem pembayaran sedang dalam maintenance. Silakan hubungi admin.",
                ephemeral=True
            )
        await interaction.response.send_modal(TopupModal())

    @ui.button(
        label="üí≥ Info Saldo",
        style=discord.ButtonStyle.gray,
        custom_id="check_balance_button"
    )
    async def check_balance(self, interaction: Interaction, button: ui.Button):
        """Cek saldo user"""
        user_id = interaction.user.id
        balance = get_balance(user_id)
        stats = get_user_stats(user_id)
        
        embed = discord.Embed(
            title="üí≥ Informasi Akun Anda",
            color=0x3498db
        )
        embed.add_field(
            name="üí∞ Saldo Tersedia", 
            value=format_rupiah(balance), 
            inline=False
        )
        embed.add_field(
            name="üìä Statistik",
            value=f"‚Ä¢ Total Top Up: {format_rupiah(stats['total_topup'])}\n"
                  f"‚Ä¢ Total Penggunaan: {format_rupiah(stats['total_spent'])}\n"
                  f"‚Ä¢ Redeem Berhasil: {stats['success_redeem']}\n"
                  f"‚Ä¢ Redeem Gagal: {stats['failed_redeem']}",
            inline=False
        )
        embed.set_footer(text=f"User ID: {user_id}")
        
        await interaction.response.send_message(embed=embed, ephemeral=True)

    @ui.button(
        label="‚ÑπÔ∏è Bantuan",
        style=discord.ButtonStyle.gray,
        custom_id="help_button"
    )
    async def help_menu(self, interaction: Interaction, button: ui.Button):
        """Tampilkan menu bantuan"""
        embed = discord.Embed(
            title="‚ÑπÔ∏è Panduan Penggunaan Bot",
            description="Berikut adalah cara menggunakan bot redeem code ini:",
            color=0x9b59b6
        )
        
        embed.add_field(
            name="1Ô∏è‚É£ Top Up Saldo",
            value="Klik tombol **üí∞ Top Up Saldo** untuk mengisi saldo via QRIS. "
                  "Pembayaran otomatis terverifikasi dalam hitungan detik.",
            inline=False
        )
        
        embed.add_field(
            name="2Ô∏è‚É£ Mulai Redeem",
            value="Klik tombol **üéÆ Mulai Redeem** untuk membuat sesi privat. "
                  "Bot akan membuatkan channel khusus untuk Anda.",
            inline=False
        )
        
        embed.add_field(
            name="3Ô∏è‚É£ Input Parameter",
            value="Isi informasi akun CloudEmulator Anda (email, password, region, dll).",
            inline=False
        )
        
        embed.add_field(
            name="4Ô∏è‚É£ Upload File Kode",
            value="Upload file `code.txt` yang berisi kode redeem (satu kode per baris).",
            inline=False
        )
        
        embed.add_field(
            name="üí∞ Biaya",
            value=f"Biaya redeem: **{format_rupiah(config.REDEEM_COST_PER_CODE)}** per kode\n"
                  f"Top up minimal: **{format_rupiah(config.MIN_TOPUP_AMOUNT)}**",
            inline=False
        )
        
        embed.add_field(
            name="üìù Command Tersedia",
            value="`!saldo` - Cek saldo Anda\n"
                  "`!stats` - Lihat statistik lengkap\n"
                  "`!close` - Tutup channel redeem\n"
                  "`!help` - Panduan lengkap",
            inline=False
        )
        
        embed.add_field(
            name="‚ùì Butuh Bantuan?",
            value="Hubungi admin jika mengalami kendala atau ada pertanyaan.",
            inline=False
        )
        
        embed.set_footer(text="Bot Redeem Code ‚Ä¢ CloudEmulator")
        
        await interaction.response.send_message(embed=embed, ephemeral=True)

# ==============================
# User Help View (untuk private channel)
# ==============================
class UserHelpView(ui.View):
    def __init__(self):
        super().__init__(timeout=None)

    @ui.button(
        label="üìñ Bantuan & Command",
        style=discord.ButtonStyle.gray,
        custom_id="user_help_view_button"
    )
    async def show_help(self, interaction: Interaction, button: ui.Button):
        """Show help in private channel"""
        embed = discord.Embed(
            title="üìñ Bantuan & Command",
            description="Panduan lengkap untuk channel redeem ini:",
            color=0x3498db
        )
        
        embed.add_field(
            name="üîπ Cara Mulai Redeem",
            value="1. Klik tombol **üìù Input Parameter**\n"
                  "2. Isi email, password, region, dan versi Android\n"
                  "3. Upload file `code.txt` berisi kode redeem\n"
                  "4. Tunggu proses selesai",
            inline=False
        )
        
        embed.add_field(
            name="üí∞ Informasi Biaya",
            value=f"‚Ä¢ Biaya per kode: **{format_rupiah(config.REDEEM_COST_PER_CODE)}**\n"
                  f"‚Ä¢ Maksimal upload: **{config.MAX_CODES_PER_UPLOAD} kode**\n"
                  f"‚Ä¢ Biaya dipotong otomatis dari saldo",
            inline=False
        )
        
        embed.add_field(
            name="üìù Command Berguna",
            value="`!saldo` - Cek saldo Anda\n"
                  "`!stats` - Lihat statistik redeem\n"
                  "`!close` - Tutup channel ini",
            inline=False
        )
        
        embed.add_field(
            name="üìã Format File code.txt",
            value="```\nDMA4-FY6T-ASFL\nABC1-XYZ2-DEF3\nGHI4-JKL5-MNO6\n```\nSatu kode per baris, tanpa spasi ekstra",
            inline=False
        )
        
        embed.add_field(
            name="üåç Region Tersedia",
            value="`hk` - Hong Kong\n"
                  "`sg` - Singapore\n"
                  "`us` - United States\n"
                  "`tw` - Taiwan\n"
                  "`th` - Thailand",
            inline=False
        )
        
        embed.add_field(
            name="üì± Versi Android",
            value="`1` - Android 8.1\n"
                  "`2` - Android 10\n"
                  "`3` - Android 12",
            inline=False
        )
        
        embed.add_field(
            name="‚ö†Ô∏è Perhatian",
            value="‚Ä¢ Pastikan akun CloudEmulator valid\n"
                  "‚Ä¢ Kode yang invalid tidak akan di-refund\n"
                  "‚Ä¢ Proses mungkin memakan waktu beberapa menit\n"
                  "‚Ä¢ Jangan tutup channel saat proses berlangsung",
            inline=False
        )
        
        embed.set_footer(text="Butuh bantuan lebih? Hubungi admin")
        
        await interaction.response.send_message(embed=embed, ephemeral=True)

# ==============================
# Admin Control Panel
# ==============================
class AdminControlPanel(ui.View):
    def __init__(self):
        super().__init__(timeout=None)

    @ui.button(
        label="üìä System Stats",
        style=discord.ButtonStyle.blurple,
        custom_id="admin_stats_button",
        row=0
    )
    async def show_stats(self, interaction: Interaction, button: ui.Button):
        """Show system statistics"""
        # Check admin
        admin_role = discord.utils.get(interaction.guild.roles, name=config.ADMIN_ROLE_NAME)
        if not admin_role or admin_role not in interaction.user.roles:
            return await interaction.response.send_message("‚ùå Admin only!", ephemeral=True)
        
        try:
            stats = get_database_stats()
            queue_count = get_redeem_queue_count()
            
            # Worker status
            workers_active = sum(1 for s in worker_status.values() if s == "processing")
            workers_idle = sum(1 for s in worker_status.values() if s == "idle")
            
            embed = discord.Embed(
                title="üìä System Statistics",
                description="Real-time bot statistics",
                color=0xe74c3c
            )
            
            embed.add_field(
                name="üë• Users",
                value=f"**{stats['total_users']}** registered users",
                inline=True
            )
            
            embed.add_field(
                name="üí∞ Total Balance",
                value=format_rupiah(stats['total_balance']),
                inline=True
            )
            
            embed.add_field(
                name="üì¶ Queue",
                value=f"**{queue_count}** tasks waiting",
                inline=True
            )
            
            embed.add_field(
                name="üìà Top Up Stats",
                value=f"‚Ä¢ Transactions: **{stats['successful_topups']}**\n"
                      f"‚Ä¢ Total Amount: {format_rupiah(stats['total_topup_amount'])}",
                inline=False
            )
            
            total_redeems = stats['successful_redeems'] + stats['failed_redeems']
            success_rate = (stats['successful_redeems'] / total_redeems * 100) if total_redeems > 0 else 0
            
            embed.add_field(
                name="üéÆ Redeem Stats",
                value=f"‚Ä¢ Success: **{stats['successful_redeems']}**\n"
                      f"‚Ä¢ Failed: **{stats['failed_redeems']}**\n"
                      f"‚Ä¢ Pending: **{stats['pending_redeems']}**\n"
                      f"‚Ä¢ Success Rate: **{success_rate:.1f}%**",
                inline=False
            )
            
            embed.add_field(
                name="‚öôÔ∏è Workers",
                value=f"‚Ä¢ Active: **{workers_active}**\n"
                      f"‚Ä¢ Idle: **{workers_idle}**\n"
                      f"‚Ä¢ Total: **{config.MAX_LOGIN_WORKERS}**",
                inline=True
            )
            
            embed.add_field(
                name="üåê System",
                value=f"‚Ä¢ Servers: **{len(bot.guilds)}**\n"
                      f"‚Ä¢ Active Sessions: **{len(active_channels)}**",
                inline=True
            )
            
            embed.timestamp = datetime.now()
            embed.set_footer(text="Updated")
            
            await interaction.response.send_message(embed=embed, ephemeral=True)
            
        except Exception as e:
            print(f"‚ùå Error showing stats: {e}")
            await interaction.response.send_message("‚ùå Error fetching stats", ephemeral=True)

    @ui.button(
        label="üìñ Admin Commands",
        style=discord.ButtonStyle.gray,
        custom_id="admin_help_button",
        row=0
    )
    async def show_admin_help(self, interaction: Interaction, button: ui.Button):
        """Show admin commands"""
        # Check admin
        admin_role = discord.utils.get(interaction.guild.roles, name=config.ADMIN_ROLE_NAME)
        if not admin_role or admin_role not in interaction.user.roles:
            return await interaction.response.send_message("‚ùå Admin only!", ephemeral=True)
        
        embed = discord.Embed(
            title="üõ°Ô∏è Admin Commands Reference",
            description="Complete list of admin commands and their usage",
            color=0xe74c3c
        )
        
        embed.add_field(
            name="üí∞ Balance Management",
            value="`!addbalance @user [amount]`\n"
                  "Add balance to specific user manually",
            inline=False
        )
        
        embed.add_field(
            name="üë• User Management",
            value="`!checkuser @user`\n"
                  "View detailed user statistics and info",
            inline=False
        )
        
        embed.add_field(
            name="üí≥ Transaction Management",
            value="`!checktransaction [order_id]`\n"
                  "Check transaction details by Order ID",
            inline=False
        )
        
        embed.add_field(
            name="üìä System Monitoring",
            value="`!botstats`\n"
                  "View comprehensive bot statistics\n\n"
                  "Or use the **üìä System Stats** button above",
            inline=False
        )
        
        embed.add_field(
            name="üì¢ Communication",
            value="`!broadcast [message]`\n"
                  "Send announcement to all users (requires confirmation)",
            inline=False
        )
        
        embed.add_field(
            name="‚ÑπÔ∏è Help",
            value="`!adminhelp`\n"
                  "Show this admin commands list",
            inline=False
        )
        
        embed.add_field(
            name="‚öôÔ∏è Bot Configuration",
            value=f"‚Ä¢ Max Workers: **{config.MAX_LOGIN_WORKERS}**\n"
                  f"‚Ä¢ Cost per Code: {format_rupiah(config.REDEEM_COST_PER_CODE)}\n"
                  f"‚Ä¢ Min Top Up: {format_rupiah(config.MIN_TOPUP_AMOUNT)}\n"
                  f"‚Ä¢ Max Codes: **{config.MAX_CODES_PER_UPLOAD}**\n"
                  f"‚Ä¢ Admin Role: **{config.ADMIN_ROLE_NAME}**",
            inline=False
        )
        
        embed.add_field(
            name="‚ö†Ô∏è Important Notes",
            value="‚Ä¢ All admin actions are logged\n"
                  "‚Ä¢ Use commands responsibly\n"
                  "‚Ä¢ Broadcast requires confirmation\n"
                  "‚Ä¢ Balance changes are permanent",
            inline=False
        )
        
        embed.set_footer(text=f"Admin Role: {config.ADMIN_ROLE_NAME}")
        
        await interaction.response.send_message(embed=embed, ephemeral=True)

    @ui.button(
        label="üîÑ Refresh Stats",
        style=discord.ButtonStyle.green,
        custom_id="admin_refresh_button",
        row=0
    )
    async def refresh_stats(self, interaction: Interaction, button: ui.Button):
        """Refresh and show updated stats"""
        # Check admin
        admin_role = discord.utils.get(interaction.guild.roles, name=config.ADMIN_ROLE_NAME)
        if not admin_role or admin_role not in interaction.user.roles:
            return await interaction.response.send_message("‚ùå Admin only!", ephemeral=True)
        
        await interaction.response.defer(ephemeral=True)
        
        try:
            stats = get_database_stats()
            queue_count = get_redeem_queue_count()
            
            workers_active = sum(1 for s in worker_status.values() if s == "processing")
            workers_idle = sum(1 for s in worker_status.values() if s == "idle")
            
            embed = discord.Embed(
                title="üîÑ Refreshed System Statistics",
                description="Latest real-time data",
                color=0x2ecc71
            )
            
            embed.add_field(
                name="üë• Users", 
                value=f"**{stats['total_users']}**", 
                inline=True
            )
            embed.add_field(
                name="üí∞ Balance", 
                value=format_rupiah(stats['total_balance']), 
                inline=True
            )
            embed.add_field(
                name="üì¶ Queue", 
                value=f"**{queue_count}**", 
                inline=True
            )
            
            embed.add_field(
                name="‚öôÔ∏è Workers",
                value=f"Active: **{workers_active}** | Idle: **{workers_idle}**",
                inline=False
            )
            
            embed.add_field(
                name="üéÆ Redeems Today",
                value=f"Success: **{stats['successful_redeems']}** | "
                      f"Failed: **{stats['failed_redeems']}** | "
                      f"Pending: **{stats['pending_redeems']}**",
                inline=False
            )
            
            embed.timestamp = datetime.now()
            embed.set_footer(text="Refreshed at")
            
            await interaction.followup.send(embed=embed, ephemeral=True)
            
        except Exception as e:
            print(f"‚ùå Error refreshing stats: {e}")
            await interaction.followup.send("‚ùå Error refreshing stats", ephemeral=True)

# ==============================
# Topup Modal
# ==============================
class TopupModal(ui.Modal, title="üí∞ Top Up Saldo"):
    amount = ui.TextInput(
        label="Jumlah Top Up (Rupiah)",
        placeholder=f"Minimal Rp {config.MIN_TOPUP_AMOUNT:,}",
        min_length=4,
        max_length=10
    )

    async def on_submit(self, interaction: Interaction):
        try:
            amount_value = int(self.amount.value.strip().replace('.', '').replace(',', ''))
            
            if amount_value < config.MIN_TOPUP_AMOUNT:
                return await interaction.response.send_message(
                    f"‚ùå Minimal top up adalah **{format_rupiah(config.MIN_TOPUP_AMOUNT)}**",
                    ephemeral=True
                )
            
            if amount_value > 10000000:  # Max 10 juta
                return await interaction.response.send_message(
                    "‚ùå Maksimal top up adalah **Rp 10.000.000** per transaksi",
                    ephemeral=True
                )
            
            # Generate order ID
            order_id = generate_order_id(interaction.user.id)
            
            # Customer details
            customer_details = {
                "first_name": interaction.user.name[:50],
                "email": f"{interaction.user.id}@discord.user",
                "phone": "08123456789"
            }
            
            await interaction.response.defer(ephemeral=True)
            
            # Create transaction
            transaction = midtrans.create_qris_transaction(
                order_id=order_id,
                amount=amount_value,
                customer_details=customer_details
            )
            
            if not transaction:
                return await interaction.followup.send(
                    "‚ùå Gagal membuat transaksi pembayaran. Silakan coba lagi dalam beberapa saat.",
                    ephemeral=True
                )
            
            # Simpan ke database
            create_topup(interaction.user.id, amount_value, order_id)
            
            # QR code URL
            qr_url = transaction.get('actions', [{}])[0].get('url', '')
            
            # Kirim ke DM
            try:
                embed = discord.Embed(
                    title="üí≥ Pembayaran QRIS",
                    description=f"Scan QR code di bawah untuk membayar **{format_rupiah(amount_value)}**",
                    color=0x00ff00
                )
                embed.add_field(name="üÜî Order ID", value=f"`{order_id}`", inline=False)
                embed.add_field(name="üí∞ Jumlah", value=format_rupiah(amount_value), inline=True)
                embed.add_field(name="‚è±Ô∏è Berlaku", value="15 menit", inline=True)
                embed.set_image(url=qr_url)
                embed.add_field(
                    name="‚ÑπÔ∏è Informasi",
                    value="‚Ä¢ Pembayaran otomatis terverifikasi\n"
                          "‚Ä¢ Saldo akan langsung masuk setelah pembayaran berhasil\n"
                          "‚Ä¢ Anda akan menerima notifikasi via DM",
                    inline=False
                )
                embed.set_footer(text="Terima kasih telah menggunakan layanan kami")
                
                await interaction.user.send(embed=embed)
                
                await interaction.followup.send(
                    f"‚úÖ **Invoice pembayaran telah dikirim ke DM Anda!**\n\n"
                    f"üìã Order ID: `{order_id}`\n"
                    f"üí∞ Jumlah: **{format_rupiah(amount_value)}**\n"
                    f"‚è±Ô∏è Berlaku: 15 menit\n\n"
                    f"üí° Silakan cek DM Anda dan scan QR code untuk melakukan pembayaran.",
                    ephemeral=True
                )
                
            except discord.Forbidden:
                embed = discord.Embed(
                    title="‚ö†Ô∏è Tidak Dapat Mengirim DM",
                    description="Silakan aktifkan DM untuk menerima invoice pembayaran.",
                    color=0xf39c12
                )
                embed.add_field(name="QR Code", value=f"[Klik di sini untuk membayar]({qr_url})", inline=False)
                embed.add_field(name="Order ID", value=f"`{order_id}`", inline=False)
                
                await interaction.followup.send(embed=embed, ephemeral=True)
                
        except ValueError:
            await interaction.response.send_message(
                "‚ùå Format jumlah tidak valid. Harap masukkan angka saja.",
                ephemeral=True
            )
        except Exception as e:
            print(f"‚ùå Topup error: {e}")
            print(traceback.format_exc())
            
            try:
                await interaction.followup.send(
                    "‚ùå Terjadi kesalahan saat memproses top up. Silakan coba lagi atau hubungi admin.",
                    ephemeral=True
                )
            except:
                pass

# ==============================
# Start Form Button
# ==============================
class StartFormButton(ui.View):
    def __init__(self):
        super().__init__(timeout=None)

    @ui.button(
        label="üìù Input Parameter",
        style=discord.ButtonStyle.blurple,
        custom_id="input_parameter_button",
        row=0
    )
    async def open_form(self, interaction: Interaction, button: ui.Button):
        await interaction.response.send_modal(RedeemModal())

    @ui.button(
        label="üìñ Bantuan",
        style=discord.ButtonStyle.gray,
        custom_id="private_help_button",
        row=0
    )
    async def show_help(self, interaction: Interaction, button: ui.Button):
        """Show help in private channel"""
        embed = discord.Embed(
            title="üìñ Bantuan & Command",
            description="Panduan lengkap untuk channel redeem ini:",
            color=0x3498db
        )
        
        embed.add_field(
            name="üîπ Cara Mulai Redeem",
            value="1. Klik tombol **üìù Input Parameter**\n"
                  "2. Isi email, password, region, dan versi Android\n"
                  "3. Upload file `code.txt` berisi kode redeem\n"
                  "4. Tunggu proses selesai",
            inline=False
        )
        
        embed.add_field(
            name="üí∞ Informasi Biaya",
            value=f"‚Ä¢ Biaya per kode: **{format_rupiah(config.REDEEM_COST_PER_CODE)}**\n"
                  f"‚Ä¢ Maksimal upload: **{config.MAX_CODES_PER_UPLOAD} kode**\n"
                  f"‚Ä¢ Biaya dipotong otomatis dari saldo",
            inline=False
        )
        
        embed.add_field(
            name="üìù Command Berguna",
            value="`!saldo` - Cek saldo Anda\n"
                  "`!stats` - Lihat statistik redeem\n"
                  "`!close` - Tutup channel ini",
            inline=False
        )
        
        embed.add_field(
            name="üìã Format File code.txt",
            value="```\nDMA4-FY6T-ASFL\nABC1-XYZ2-DEF3\nGHI4-JKL5-MNO6\n```\nSatu kode per baris, tanpa spasi ekstra",
            inline=False
        )
        
        embed.add_field(
            name="üåç Region Tersedia",
            value="`hk` - Hong Kong\n"
                  "`sg` - Singapore\n"
                  "`us` - United States\n"
                  "`tw` - Taiwan\n"
                  "`th` - Thailand",
            inline=False
        )
        
        embed.add_field(
            name="üì± Versi Android",
            value="`1` - Android 8.1\n"
                  "`2` - Android 10\n"
                  "`3` - Android 12",
            inline=False
        )
        
        embed.add_field(
            name="‚ö†Ô∏è Perhatian",
            value="‚Ä¢ Pastikan akun CloudEmulator valid\n"
                  "‚Ä¢ Kode yang invalid tidak akan di-refund\n"
                  "‚Ä¢ Proses mungkin memakan waktu beberapa menit\n"
                  "‚Ä¢ Jangan tutup channel saat proses berlangsung",
            inline=False
        )
        
        embed.set_footer(text="Butuh bantuan lebih? Hubungi admin")
        
        await interaction.response.send_message(embed=embed, ephemeral=True)

# ==============================
# Redeem Modal
# ==============================
class RedeemModal(ui.Modal, title="üìã Parameter Akun Redeem"):
    email = ui.TextInput(
        label="Email",
        placeholder="Email akun CloudEmulator Anda"
    )
    password = ui.TextInput(
        label="Password",
        placeholder="Password akun",
        style=discord.TextStyle.short
    )
    region = ui.TextInput(
        label="Region",
        placeholder="Contoh: hk sg th (pisahkan dengan spasi)"
    )
    android = ui.TextInput(
        label="Versi Android",
        placeholder="Pilih: 1 (Android 8.1) | 2 (Android 10) | 3 (Android 12)"
    )

    async def on_submit(self, interaction: Interaction):
        try:
            android_choice = int(self.android.value.strip())
            if android_choice not in [1, 2, 3]:
                raise ValueError()
        except:
            return await interaction.response.send_message(
                "‚ùå Versi Android tidak valid. Pilih: **1** (Android 8.1), **2** (Android 10), atau **3** (Android 12)",
                ephemeral=True
            )

        # Validasi region
        valid_regions = ['hk', 'sg', 'us', 'tw', 'th']
        region_input = self.region.value.strip().lower()
        regions = region_input.split()
        
        invalid_regions = [r for r in regions if r not in valid_regions]
        if invalid_regions:
            return await interaction.response.send_message(
                f"‚ùå Region tidak valid: **{', '.join(invalid_regions)}**\n\n"
                f"Region yang tersedia: **hk, sg, us, tw, th**",
                ephemeral=True
            )

        user_data[interaction.user.id] = {
            "email": self.email.value.strip(),
            "password": self.password.value.strip(),
            "region": region_input,
            "android_choice": android_choice,
            "user": interaction.user
        }

        android_names = {1: "Android 8.1", 2: "Android 10", 3: "Android 12"}
        
        embed = discord.Embed(
            title="‚úÖ Parameter Berhasil Disimpan",
            description="Informasi akun Anda telah tersimpan dengan aman.",
            color=0x2ecc71
        )
        embed.add_field(name="üìß Email", value=self.email.value, inline=False)
        embed.add_field(name="üåè Region", value=region_input.upper(), inline=True)
        embed.add_field(name="üì± Android", value=android_names[android_choice], inline=True)
        embed.add_field(
            name="üìÅ Langkah Selanjutnya",
            value="Silakan upload file **`code.txt`** yang berisi kode redeem Anda.\n"
                  "Format: satu kode per baris",
            inline=False
        )
        embed.set_footer(text="Data Anda aman dan akan dihapus setelah proses selesai")

        await interaction.response.send_message(embed=embed, ephemeral=False)

# ==============================
# File Upload Handler
# ==============================
@bot.event
async def on_message(message: discord.Message):
    if message.author == bot.user:
        return

    if isinstance(message.channel, discord.TextChannel):
        if message.channel.name.startswith("redeem-") and len(message.attachments) > 0:
            user_info = user_data.get(message.author.id)
            if not user_info:
                return await safe_send(message.channel,
                    "‚ö†Ô∏è Silakan isi parameter terlebih dahulu dengan klik tombol **Input Parameter**."
                )

            attachment = message.attachments[0]

            if not attachment.filename.endswith(".txt"):
                return await safe_send(message.channel,
                    "‚ùå File harus berformat **`.txt`**\n\n"
                    "üí° Pastikan file berisi kode redeem dengan format satu kode per baris."
                )

            try:
                # Read and validate codes
                content = await attachment.read()
                codes = [line.strip() for line in content.decode('utf-8').split('\n') if line.strip()]
                code_count = len(codes)
                
                if code_count == 0:
                    return await safe_send(message.channel,
                        "‚ùå File kode kosong!\n\n"
                        "üí° Pastikan file berisi minimal satu kode redeem."
                    )
                
                # Check limit
                if code_count > config.MAX_CODES_PER_UPLOAD:
                    return await safe_send(message.channel,
                        f"‚ùå **Terlalu Banyak Kode!**\n\n"
                        f"‚Ä¢ Maksimal: **{config.MAX_CODES_PER_UPLOAD} kode** per upload\n"
                        f"‚Ä¢ Kode Anda: **{code_count} kode**\n\n"
                        f"üí° Silakan bagi file menjadi beberapa bagian yang lebih kecil."
                    )
                
                # Calculate cost
                total_cost = code_count * config.REDEEM_COST_PER_CODE
                user_balance = get_balance(message.author.id)
                
                # Check balance
                if user_balance < total_cost:
                    shortage = total_cost - user_balance
                    embed = discord.Embed(
                        title="üí≥ Saldo Tidak Mencukupi",
                        description="Maaf, saldo Anda tidak cukup untuk memproses kode sebanyak ini.",
                        color=0xe74c3c
                    )
                    embed.add_field(name="üì¶ Jumlah Kode", value=f"{code_count} kode", inline=True)
                    embed.add_field(name="üí∞ Total Biaya", value=format_rupiah(total_cost), inline=True)
                    embed.add_field(name="üí≥ Saldo Anda", value=format_rupiah(user_balance), inline=True)
                    embed.add_field(name="‚ö†Ô∏è Kekurangan", value=format_rupiah(shortage), inline=True)
                    embed.add_field(
                        name="üí° Solusi",
                        value="Kembali ke channel utama dan klik tombol **üí∞ Top Up Saldo** untuk mengisi saldo.",
                        inline=False
                    )
                    return await safe_send(message.channel, embed=embed)
                
                # Deduct balance
                if not deduct_balance(message.author.id, total_cost):
                    return await safe_send(message.channel,
                        "‚ùå Gagal memproses pembayaran. Silakan coba lagi atau hubungi admin."
                    )
                
                # Save file
                temp_code_file = f"code_temp_{user_info['user'].id}.txt"
                await attachment.save(temp_code_file)

                # Add to queue
                await login_queue.put({
                    "user_id": user_info['user'].id,
                    "email": user_info["email"],
                    "password": user_info["password"],
                    "region": user_info["region"],
                    "android_choice": user_info["android_choice"],
                    "channel": message.channel,
                    "code_file": temp_code_file
                })

                new_balance = get_balance(message.author.id)
                queue_size = login_queue.qsize()
                
                embed = discord.Embed(
                    title="‚úÖ File Diterima & Saldo Terpotong",
                    description="Redeem code Anda sedang diproses!",
                    color=0x2ecc71
                )
                embed.add_field(name="üì¶ Jumlah Kode", value=f"{code_count} kode", inline=True)
                embed.add_field(name="üí∞ Biaya", value=format_rupiah(total_cost), inline=True)
                embed.add_field(name="üí≥ Saldo Tersisa", value=format_rupiah(new_balance), inline=True)
                embed.add_field(
                    name="üìä Status",
                    value=f"‚Ä¢ Posisi antrian: **{queue_size}**\n"
                          f"‚Ä¢ Status: Menunggu pemrosesan\n"
                          f"‚Ä¢ Estimasi: {queue_size * 2}-{queue_size * 5} menit",
                    inline=False
                )
                embed.add_field(
                    name="‚ÑπÔ∏è Informasi",
                    value="Proses redeem akan dimulai segera. Anda akan menerima notifikasi saat selesai.",
                    inline=False
                )
                embed.set_footer(text="Mohon bersabar, proses mungkin memakan waktu beberapa menit")
                
                await safe_send(message.channel, embed=embed)
                
            except UnicodeDecodeError:
                await safe_send(message.channel,
                    "‚ùå File tidak dapat dibaca!\n\n"
                    "üí° Pastikan file adalah text file UTF-8 yang valid."
                )
            except Exception as e:
                print(f"‚ùå File processing error: {e}")
                print(traceback.format_exc())
                await safe_send(message.channel,
                    "‚ùå Terjadi kesalahan saat memproses file. Silakan coba lagi atau hubungi admin."
                )

    await bot.process_commands(message)

# ==============================
# Commands
# ==============================
@bot.command(name='saldo')
async def check_balance_command(ctx):
    """Cek saldo Anda"""
    balance = get_balance(ctx.author.id)
    await ctx.send(f"üí∞ Saldo Anda: **{format_rupiah(balance)}**")

@bot.command(name='stats')
async def stats_command(ctx):
    """Lihat statistik akun Anda"""
    stats = get_user_stats(ctx.author.id)
    
    embed = discord.Embed(
        title="üìä Statistik Akun Anda",
        color=0x9b59b6
    )
    embed.add_field(name="üí∞ Saldo", value=format_rupiah(stats['balance']), inline=True)
    embed.add_field(name="üìà Total Top Up", value=format_rupiah(stats['total_topup']), inline=True)
    embed.add_field(name="üìâ Total Pengeluaran", value=format_rupiah(stats['total_spent']), inline=True)
    embed.add_field(name="‚úÖ Redeem Berhasil", value=str(stats['success_redeem']), inline=True)
    embed.add_field(name="‚ùå Redeem Gagal", value=str(stats['failed_redeem']), inline=True)
    embed.add_field(name="üì¶ Total Redeem", value=str(stats['total_redeem']), inline=True)
    embed.set_footer(text=f"User ID: {ctx.author.id}")
    
    await ctx.send(embed=embed)

@bot.command(name='close')
async def close_channel_command(ctx):
    """Tutup channel redeem privat"""
    if not ctx.channel.name.startswith("redeem-"):
        return await ctx.send("‚ÑπÔ∏è Command ini hanya bisa digunakan di channel redeem.")
    
    is_owner = ctx.author.id in active_channels and active_channels[ctx.author.id] == ctx.channel.id
    admin_role = discord.utils.get(ctx.guild.roles, name=config.ADMIN_ROLE_NAME)
    is_admin = admin_role in ctx.author.roles if admin_role else False
    
    if not (is_owner or is_admin):
        return await ctx.send("‚ùå Anda tidak memiliki izin untuk menutup channel ini.")
    
    if ctx.author.id in active_channels:
        active_channels.pop(ctx.author.id)
    
    await ctx.send("üëã Channel ini akan ditutup dalam 5 detik. Terima kasih telah menggunakan layanan kami!")
    await asyncio.sleep(5)
    
    try:
        await ctx.channel.delete(reason=f"Ditutup oleh {ctx.author.name}")
    except:
        pass

# ==============================
# Error Handler
# ==============================
@bot.event
async def on_command_error(ctx, error):
    """Global error handler untuk commands"""
    if isinstance(error, commands.CommandNotFound):
        return  # Ignore unknown commands
    
    if isinstance(error, commands.MissingPermissions):
        await ctx.send("‚ùå Anda tidak memiliki izin untuk menggunakan command ini.")
        return
    
    if isinstance(error, commands.BotMissingPermissions):
        await ctx.send("‚ùå Bot tidak memiliki izin yang diperlukan untuk menjalankan command ini.")
        return
    
    # Log unexpected errors
    print(f"‚ùå Command error in {ctx.command}: {error}")
    print(traceback.format_exc())
    
    await ctx.send(
        "‚ùå Terjadi kesalahan saat menjalankan command. "
        "Silakan coba lagi atau hubungi admin jika masalah berlanjut."
    )

# ==============================
# Ready Event & Admin Channel Setup
# ==============================
@bot.event
async def on_ready():
    """Bot ready event"""
    print(f"‚úÖ Bot berhasil login sebagai {bot.user}")
    print(f"üìä Connected to {len(bot.guilds)} server(s)")
    
    # Set bot status
    try:
        await bot.change_presence(
            activity=discord.Activity(
                type=discord.ActivityType.watching,
                name="redeem codes | !help"
            )
        )
    except:
        pass
    
    # Start webhook server
    try:
        webhook_server.set_discord_bot(bot)
        webhook_server.start_webhook_server()
        print(f"‚úÖ Webhook server started on port {config.WEBHOOK_PORT}")
    except Exception as e:
        print(f"‚ö†Ô∏è Webhook server warning: {e}")

    # Send/update main menu
    try:
        channel = bot.get_channel(config.PUBLIC_CHANNEL_ID)
        if channel:
            embed = discord.Embed(
                title="ü§ñ Bot Redeem Code CloudEmulator",
                description="Selamat datang! Pilih menu di bawah untuk memulai:",
                color=0x2ecc71
            )
            
            embed.add_field(
                name="üéÆ Mulai Redeem",
                value="Buat sesi privat untuk redeem code Anda secara otomatis",
                inline=False
            )
            embed.add_field(
                name="üí∞ Top Up Saldo",
                value="Isi saldo dengan mudah via QRIS (pembayaran otomatis terverifikasi)",
                inline=False
            )
            embed.add_field(
                name="üí≥ Info Saldo",
                value="Cek saldo dan statistik akun Anda",
                inline=False
            )
            embed.add_field(
                name="‚ÑπÔ∏è Bantuan",
                value="Panduan lengkap cara menggunakan bot ini",
                inline=False
            )
            
            embed.add_field(
                name="üí∞ Informasi Biaya",
                value=f"‚Ä¢ Biaya redeem: **{format_rupiah(config.REDEEM_COST_PER_CODE)}** per kode\n"
                      f"‚Ä¢ Top up minimal: **{format_rupiah(config.MIN_TOPUP_AMOUNT)}**\n"
                      f"‚Ä¢ Maksimal kode per upload: **{config.MAX_CODES_PER_UPLOAD}** kode",
                inline=False
            )
            
            embed.set_footer(
                text="Bot Redeem Code ‚Ä¢ Powered by CloudEmulator",
                icon_url=bot.user.display_avatar.url if bot.user.display_avatar else None
            )
            
            await channel.send(embed=embed, view=MainMenuView())
            print(f"‚úÖ Main menu sent to channel {channel.id}")
    except Exception as e:
        print(f"‚ö†Ô∏è Could not send main menu: {e}")

    # Setup Admin Channel
    try:
        for guild in bot.guilds:
            # Cari atau buat category untuk admin
            admin_category = discord.utils.get(guild.categories, name="üõ°Ô∏è Admin Control")
            if not admin_category:
                # Create admin category
                admin_role = discord.utils.get(guild.roles, name=config.ADMIN_ROLE_NAME)
                
                overwrites = {
                    guild.default_role: discord.PermissionOverwrite(read_messages=False),
                    guild.me: discord.PermissionOverwrite(read_messages=True, send_messages=True),
                }
                
                if admin_role:
                    overwrites[admin_role] = discord.PermissionOverwrite(
                        read_messages=True, 
                        send_messages=True,
                        manage_messages=True
                    )
                
                admin_category = await guild.create_category(
                    "üõ°Ô∏è Admin Control",
                    overwrites=overwrites
                )
                print(f"‚úÖ Created admin category in {guild.name}")
            
            # Cari atau buat admin monitoring channel
            admin_channel = discord.utils.get(guild.text_channels, name="admin-dashboard")
            if not admin_channel:
                admin_channel = await guild.create_text_channel(
                    "admin-dashboard",
                    category=admin_category
                )
                print(f"‚úÖ Created admin channel in {guild.name}")
            
            # Send admin panel
            embed = discord.Embed(
                title="üõ°Ô∏è Admin Control Panel",
                description="Selamat datang di dashboard admin. Gunakan tombol di bawah untuk monitoring dan management.",
                color=0xe74c3c
            )
            
            embed.add_field(
                name="üìä System Stats",
                value="View real-time bot statistics and performance metrics",
                inline=False
            )
            
            embed.add_field(
                name="üìñ Admin Commands",
                value="Complete reference of all available admin commands",
                inline=False
            )
            
            embed.add_field(
                name="üîÑ Refresh Stats",
                value="Get the latest system statistics instantly",
                inline=False
            )
            
            embed.add_field(
                name="‚öôÔ∏è Quick Info",
                value=f"‚Ä¢ Bot Version: 2.0\n"
                      f"‚Ä¢ Max Workers: {config.MAX_LOGIN_WORKERS}\n"
                      f"‚Ä¢ Admin Role: {config.ADMIN_ROLE_NAME}\n"
                      f"‚Ä¢ Servers: {len(bot.guilds)}",
                inline=False
            )
            
            embed.set_footer(
                text="Admin Only ‚Ä¢ Use responsibly",
                icon_url=bot.user.display_avatar.url if bot.user.display_avatar else None
            )
            
            await admin_channel.send(embed=embed, view=AdminControlPanel())
            print(f"‚úÖ Admin panel sent to {guild.name}")
            
    except Exception as e:
        print(f"‚ö†Ô∏è Could not setup admin channel: {e}")
        print(traceback.format_exc())

# ==============================
# Import Admin Commands (Optional)
# ==============================
try:
    from admin_commands import setup_admin_commands
    setup_admin_commands(bot)
except ImportError:
    print("‚ÑπÔ∏è Admin commands not loaded (admin_commands.py not found)")
except Exception as e:
    print(f"‚ö†Ô∏è Could not load admin commands: {e}")

# ==============================
# Run Bot
# ==============================
if __name__ == "__main__":
    try:
        # Validate config
        if not config.validate_config():
            print("\nüõë Bot tidak dapat dijalankan karena konfigurasi tidak valid.")
            print("üí° Silakan perbaiki file .env terlebih dahulu.\n")
            exit(1)
        
        config.print_config()
        
        print("\nüöÄ Starting bot...")
        bot.run(config.DISCORD_TOKEN)
        
    except KeyboardInterrupt:
        print("\nüëã Bot dihentikan oleh user")
    except Exception as e:
        print(f"\n‚ùå Critical error: {e}")
        print(traceback.format_exc())